---
layout: post
title: redis入门（3）
date: 2018-07-17 07:26:42
tags: redis
categories: redis
---

### redis其他的一些命令

#### scan
迭代方式，去除满足条件的keys，相比于keys，有如下优势：
- 复杂度虽然也是 O(n)，但是它是通过游标分步进行的，不会阻塞线程;
- 提供 limit 参数，可以控制每次返回结果的最大条数，limit 只是一个 hint，返回的结果可多可少;
- 同 keys 一样，它也提供模式匹配功能;
- 服务器不需要为游标保存状态，游标的唯一状态就是 scan 返回给客户端的游标整数;
- 返回的结果可能会有重复，需要客户端去重复，这点非常重要;
- 遍历的过程中如果有数据修改，改动后的数据能不能遍历到是不确定的;
- 单次返回的结果是空的并不意味着遍历结束，而要看返回的游标值是否为零;

可以使用`scan 0`代替`keys`。
```shell
#匹配所有以key99开头的所有键
> keys keys99*            #传统方式，百万级数据时很慢，不推荐
...
> scan 0 match key99* count 1000    #这里的1000不是返回的数量，而是单次遍历的字典槽位数量,返回的结果大小不固定。返回的结果的第一个参数值会作为下一次遍历的起始位置（上一次遍历到的槽位），即为：scan 13976 match key99* count 1000
1) "13976"
2)  1) "key9911"
    2) "key9974"
    3) ...
```

<!-- more -->

>>注意：返回的结果中数组的第一个值表示游标的值，如果这个值为零，说明已经遍历完毕。

>在 Redis 中所有的 key 都存储在一个很大的字典中，这个字典的结构和 Java 中的 HashMap 一样，是一维数组 + 二维链表结构，第一维数组的大小总是 2^n(n>=0)，扩容一次数组大小空间加倍，也就是 n++。scan 指令返回的游标就是第一维数组的位置索引，我们将这个位置索引称为槽 (slot)。如果不考虑字典的扩容缩容，直接按数组下标挨个遍历就行了。limit 参数就表示需要遍历的槽位数，之所以返回的结果可能多可能少，是因为不是所有的槽位上都会挂接链表，有些槽位可能是空的，还有些槽位上挂接的链表上的元素可能会有多个。每一次遍历都会将 limit 数量的槽位上挂接的所有链表元素进行模式匹配过滤后，一次性返回给客户端。
scan的遍历考虑到字典的扩容和缩容时避免槽位的遍历重复和遗漏，采用了高位进位加法。![](http://p2jr3pegk.bkt.clouddn.com/redis03-1.png)

>所以扩容和缩容后的结构为：![](http://p2jr3pegk.bkt.clouddn.com/redis03-2.png)
>观察这张图，我们发现采用高位进位加法的遍历顺序，rehash 后的槽位在遍历顺序上是相邻的。
假设当前要即将遍历 110 这个位置 (橙色)，那么扩容后，当前槽位上所有的元素对应的新槽位是 0110 和 1110(深绿色)，也就是在槽位的二进制数增加一个高位 0 或 1。这时我们可以直接从 0110 这个槽位开始往后继续遍历，0110 槽位之前的所有槽位都是已经遍历过的，这样就可以避免扩容后对已经遍历过的槽位进行重复遍历。
再考虑缩容，假设当前即将遍历 110 这个位置 (橙色)，那么缩容后，当前槽位所有的元素对应的新槽位是 10(深绿色)，也就是去掉槽位二进制最高位。这时我们可以直接从 10 这个槽位继续往后遍历，10 槽位之前的所有槽位都是已经遍历过的，这样就可以避免缩容的重复遍历。不过缩容还是不太一样，它会对图中 010 这个槽位上的元素进行重复遍历，因为缩融后 10 槽位的元素是 010 和 110 上挂接的元素的融合。...

其他scan指令：zscan 遍历 zset 集合元素，hscan 遍历 hash 字典的元素、sscan 遍历 set 集合的元素

scan命令还可以用来定位大Key，防止添加/删除Key带来的卡顿现象，一般要求Key的大小不能超过1M。
[案例](https://mp.weixin.qq.com/s/ufoLJiXE0wU4Bc7ZbE9cDQ)

#### bigkeys
在启动服务的时候，`redis-cli -p 6380 --bigkeys`: 查看当前缓存的一个总体状况.
`redis-cli -h 127.0.0.1 -p 6380 –-bigkeys -i 0.1`:防止 ops 线上报警

#### slowlog
```shell
SLOWLOG subcommand [argument]
```
subcommand主要有：
- get，用法：slowlog get [argument]，获取argument参数指定数量的慢日志。
- len，用法：slowlog len，总慢日志数量。
- reset，用法：slowlog reset，清空慢日志。

<!-- more -->

#### monitor
开启监控。监控redis服务器上的所有操作

#### info
查看redis的运行状态参数。

#### config
redis运维常用参数。`config get *`和`config set XX XXX `

### redis其他设置
在config配置文件里，配置。可以避免测试环境中的命令影响到生产环境
```shell
rename-command flushdb flushddbb
rename-command flushall flushallall
rename-command keys keysys
```

