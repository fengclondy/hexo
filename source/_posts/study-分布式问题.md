---
layout: post
title: study-集群、分布式、负载均衡的概念理解
date: 2018-08-10 00:57:54
tags: study
categories: study
---

### 分布式事务

#### 什么是分布式事务

分布式事务指事务的参与者、支持事务的服务器、资源服务器以及事务管理器分别位于不同的分布式系统的不同节点之上。

简单的说，就是一次大的操作由不同的小操作组成，这些小的操作分布在不同的服务器上，且属于不同的应用，分布式事务需要保证这些小操作要么全部成功，要么全部失败。

本质上来说，分布式事务就是为了保证不同数据库的数据一致性。

>此处特别注意的是，区别于数据库的事务ACID（即原子性，隔离性，一致性和持久性）

#### 分布式事务产生的原因

从上面本地事务来看，我们可以分为两块：

- Service 产生多个节点
- Resource 产生多个节点


####  分布式事务基础
CAP 定理，又被叫作布鲁尔定理。（即一致性，可用性和容错性）

BASE 是 Basically Available(基本可用)、Soft state(软状态)和 Eventually consistent (最终一致性)三个短语的缩写，是对 CAP 中 AP 的一个扩展。


#### 分布式解决方案

1、进行服务拆分时，尽量把需要事务的微服务聚合成一个整体，使用数据库的本地事务。

2、2PC ，对应数据库分布式事务中的 XA Transactions。 

3、TCC，强隔离性业务。

4、本地消息表。

5、MQ事务。

6、Saga 事务。












### 分布式锁

在JAVA中，专门提供了一些处理锁机制的一些API（synchronize/Lock等），但它们只能处理线程间锁机制。对于分布式系统来说，往往讨论的是进程间的锁。

分布式锁，是指在分布式的部署环境下，通过锁机制来让多客户端互斥的对共享资源进行访问。

需满足：

- 排他性：在同一时间只会有一个客户端能获取到锁，其它客户端无法同时获取
- 避免死锁：这把锁在一段有限的时间之后，一定会被释放（正常释放或异常释放）
- 高可用：获取或释放锁的机制必须高可用且性能佳

主流实现方式，由上而下难度逐渐增加：

- 基于数据库实现（
- 基于Redis实现
- 基于ZooKeeper实现

#### 数据库实现方式

- 基于乐观锁的实现
- 基于悲观锁的实现

乐观锁机制其实就是在数据库表中引入一个版本号（version）字段来实现的。每次更新数据的时候都必须先判断版本号对不对，然后再写入新的版本号，如果版本号不对，需要重新读取数据，在写入。

悲观锁也叫作排它锁，在Mysql中是基于 for update 来实现加锁的。

#### 基于redis实现方式

主要是Set命令：

```
SET user_key user_value NX PX 100
```

NX：只在在键不存在时，才对键进行设置操作，SET key value NX 效果等同于 SETNX key value 
PX millisecond：设置键的过期时间为millisecond毫秒，当超过这个时间后，设置的键会自动失效

另外，针对redis集群模式的分布式锁，可以采用redis的Redlock机制。

#### 基于ZooKeeper实现

